name: Databricks Bundle CI/CD

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'DSA_Ops_Pipleine/databricks.yml'
      - 'DSA_Ops_Pipleine/resources/**'
      - 'DSA_Ops_Pipleine/src/**'
  push:
    branches: [ main ]

jobs:
  validate_bundle:
    runs-on:
      group: databricks-field-eng-protected-runner-group
      labels: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate YAML files
        run: |
          # Validate databricks.yml
          python -c "
          import yaml
          import sys
          try:
              with open('DSA_Ops_Pipleine/databricks.yml', 'r') as f:
                  yaml.safe_load(f)
              print('âœ… databricks.yml is valid YAML')
          except Exception as e:
              print(f'âŒ databricks.yml validation failed: {e}')
              sys.exit(1)
          "
          
          # Validate resource files
          for file in resources/*.yml; do
            if [ -f "$file" ]; then
              python -c "
          import yaml
          import sys
          try:
              with open('$file', 'r') as f:
                  yaml.safe_load(f)
              print('âœ… $file is valid YAML')
          except Exception as e:
              print(f'âŒ $file validation failed: {e}')
              sys.exit(1)
          "
            fi
          done

      - name: Check for secrets
        run: |
          # Basic secret scanning
          if grep -r -i "password\|secret\|token\" src/ --exclude-dir=.git || \
             grep -r -i "password\|secret\|token\" databricks.yml resources/; then
            echo "âŒ Potential secrets found in code"
            exit 1
          else
            echo "âœ… No obvious secrets detected"
          fi

      - name: Validate notebook structure
        run: |
          # Check that notebooks are valid JSON
          find src/ -name "*.ipynb" -exec python -m json.tool {} \; > /dev/null
          echo "âœ… All notebooks have valid JSON structure"

## Commenting out till we have permissions to set up secrets
##  databricks_validation:
##    needs: validate_bundle
##    runs-on:
##      group: databricks-field-eng-protected-runner-group
##      labels: ubuntu-latest
##    env:
##      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
##      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
##      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
##
##    steps:
##      - name: Checkout code
##        uses: actions/checkout@v4
##
##      - name: Setup Databricks CLI
##        uses: databricks/setup-cli@main
##
##      - name: Validate Databricks Bundle
##        run: databricks bundle validate
##        
##      # Optional: Deploy to staging on PR
##      - name: Deploy to staging (PR only)
##        if: github.event_name == 'pull_request'
##        run: |
##          # Only validate deployment, don't actually deploy on PR
##          echo "âœ… Bundle validation passed for PR"
##          
##      # Deploy to production on push to main
##      - name: Deploy to production (main branch only)
##        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
##        run: |
##          # You can add actual deployment here when ready
##          echo "ðŸš€ Ready for production deployment"
##          # databricks bundle deploy --target pro